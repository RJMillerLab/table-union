package main

import (
	"bufio"
	"database/sql"
	"fmt"
	"log"
	"os"
	"path"
	"strconv"
	"strings"

	. "github.com/RJMillerLab/table-union/opendata"
)

func main() {
	embTables := getEmbTables()
	log.Printf("embTableS: %d", len(embTables))
	queryTables := make([]string, 0)
	eNum := 0
	oNum := 0
	for filename := range StreamFilenames() {
		if len(queryTables) == 3000 {
			break
		}
		//if _, ok := embTables[filename]; ok {
		//	queryTables = append(queryTables, filename)
		//	eNum += 1
		//} else {
		textDomains := getTextDomains(filename)
		for _, index := range textDomains {
			filepath := path.Join(OutputDir, "domains", filename, fmt.Sprintf("%d.entities", index))
			_, err := os.Open(filepath)
			if err == nil {
				queryTables = append(queryTables, filename)
				oNum += 1
				break
			}
		}
		//}
	}

	//fout, err := os.OpenFile("/home/fnargesian/TABLE_UNION_OUTPUT/emb_or_ont.queries", os.O_CREATE|os.O_WRONLY, 0644)
	fout, err := os.OpenFile("/home/fnargesian/TABLE_UNION_OUTPUT/ontology.queries", os.O_CREATE|os.O_WRONLY, 0644)
	defer fout.Close()

	if err != nil {
		panic(err)
	}
	for _, query := range queryTables {
		fmt.Fprintf(fout, "%s\n", query)
	}
	log.Printf("Number of ontology queries: %d", oNum)
	log.Printf("Number of embedding queries: %d", eNum)
	log.Printf("Total number of queries: %d", len(queryTables))
}

func getStrantifiedSamples(sampleSize int) {
	ontTables = make(map[string]bool)
	embTables = make(map[string]bool)
	valTables = make(map[string]bool)
	ontEmbTables = make(map[string]bool)
	for filename := range StreamFilenames() {
		textDomains := getTextDomains(filename)
		if len(textDomains) == 0 {
			if _, ok := valTables[filename]; !ok {
				valTables[filename] = true
			}
			continue
		}
		for _, index := range textDomains {
			filepath := path.Join(OutputDir, "domains", filename, fmt.Sprintf("%d.entities", index))
			_, err := os.Open(filepath)
			if err == nil {
				filepath := path.Join(OutputDir, "domains", filename, fmt.Sprintf("%d.ft-sum", index))
				_, err := os.Open(filepath)
				if err == nil {
					if _, ok := ontEmbTables[filename]; !ok {
						ontEmbTables[filename] = true
					}
					continue
				} else {
					if _, ok := ontTables[filename]; !ok {
						ontTables[filename] = true
					}
				}
			}
		}
	}
	log.Printf("Num of val tables: %d", len(valTables))
	log.Printf("Num of emb tables: %d", len(embTables))
	log.Printf("Num of ont tables: %d", len(ontTables))
	log.Printf("Num of ont and emb tables: %d", len(ontEmbTables))
	numTables := len(valTables) + len(embTables) + len(ontTables) + len(ontEmbTables)
	ontSamples = make(map[string]bool)
	     embSamples = make(map[string]bool)
		      valSamples = make(map[string]bool)
			       ontEmbSamples = make(map[string]bool)
	for k,_ := range valTables {
	if len(valSamples) > (float64(len(valTables)*sampleSize)/float64(numTables)){
		continue
	}
	valSamples = append(valSamples, k)
}
}
func getEmbTables() map[string]bool {
	db, err := sql.Open("sqlite3", "/home/fnargesian/TABLE_UNION_OUTPUT/cod_fasttext_matches.db")
	if err != nil {
		panic(err)
	}
	defer db.Close()
	rows, err := db.Query(`SELECT DISTINCT datafile FROM en_query;`)
	if err != nil {
		panic(err)
	}
	//
	embTables := make(map[string]bool)
	for rows.Next() {
		var datafile string
		err := rows.Scan(&datafile)
		datafile = strings.Replace(datafile, "/home/ekzhu/OPENDATA/resource-2016-12-15-csv-only/", "", -1)
		if err != nil {
			panic(err)
		}
		embTables[datafile] = true
	}
	rows.Close()
	return embTables
}

func getTextDomains(file string) (indices []int) {
	typesFile := path.Join(OutputDir, "domains", file, "types")
	f, err := os.Open(typesFile)
	defer f.Close()
	if err != nil {
		panic(err)
	}

	scanner := bufio.NewScanner(f)
	for scanner.Scan() {
		parts := strings.SplitN(scanner.Text(), " ", 2)
		if len(parts) == 2 {
			index, err := strconv.Atoi(parts[0])
			if err != nil {
				panic(err)
			}
			if parts[1] == "text" {
				indices = append(indices, index)
			}
		}
	}

	return
}
